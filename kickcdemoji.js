"use strict";(()=>{var U=Object.create;var E=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var S=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var W=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of B(t))!q.call(e,i)&&i!==n&&E(e,i,{get:()=>t[i],enumerable:!(r=N(t,i))||r.enumerable});return e};var Y=(e,t,n)=>(n=e!=null?U(j(e)):{},W(t||!e||!e.__esModule?E(n,"default",{value:e,enumerable:!0}):n,e));var k=S((ft,z)=>{function l(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}z.exports=l;l.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};l.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};l.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},n),this._options.unref&&this._timer.unref(),!0};l.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};l.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)};l.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)};l.prototype.start=l.prototype.try;l.prototype.errors=function(){return this._errors};l.prototype.attempts=function(){return this._attempts};l.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],o=i.message,s=(e[o]||0)+1;e[o]=s,s>=n&&(t=i,n=s)}return t}});var M=S(h=>{var nt=k();h.operation=function(e){var t=h.timeouts(e);return new nt(t,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})};h.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],i=0;i<t.retries;i++)r.push(this.createTimeout(i,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(i,t)),r.sort(function(o,s){return o-s}),r};h.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout),r};h.wrap=function(e,t,n){if(t instanceof Array&&(n=t,t=null),!n){n=[];for(var r in e)typeof e[r]=="function"&&n.push(r)}for(var i=0;i<n.length;i++){var o=n[i],s=e[o];e[o]=function(m){var u=h.operation(t),a=Array.prototype.slice.call(arguments,1),_=a.pop();a.push(function(f){u.retry(f)||(f&&(arguments[0]=u.mainError()),_.apply(this,arguments))}),u.attempt(function(){m.apply(e,a)})}.bind(e,s),e[o].options=t}}});var $=S((dt,O)=>{O.exports=M()});var A=S((ht,F)=>{var rt=$();function it(e,t){function n(r,i){var o=t||{},s;"randomize"in o||(o.randomize=!0),s=rt.operation(o);function c(a){i(a||new Error("Aborted"))}function m(a,_){if(a.bail){c(a);return}s.retry(a)?o.onRetry&&o.onRetry(a,_):i(s.mainError())}function u(a){var _;try{_=e(c,a)}catch(f){m(f,a);return}Promise.resolve(_).then(r).catch(function(d){m(d,a)})}s.attempt(u)}return new Promise(n)}F.exports=it});var G={font_name:"MS PGothic",font_size:48,margin:4,outline:2,displayed_time:8},g=1280,x=720,J=`[Script Info]
ScriptType: v4.00+
PlayResX: ${g}
PlayResY: ${x}
WrapStyle: 2
ScaledBorderAndShadow: Yes
Timing: 100.0000
`,X=`
[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text`,K=function(e){let t={Name:"style",Fontname:e.font_name,Fontsize:e.font_size,PrimaryColour:"&H00FFFFFF",SecondaryColour:"&H00FFFFFF",OutlineColour:"&H80000000",BackColour:"&H00000000",Bold:-1,Italic:0,Underline:0,StrikeOut:0,ScaleX:100,ScaleY:100,Spacing:0,Angle:0,BorderStyle:1,Outline:e.outline,Shadow:0,Alignment:7,MarginL:0,MarginR:0,MarginV:0,Encoding:1};return`[V4+ Styles]
Format: ${Object.keys(t).join(", ")}
Style: ${Object.values(t).join(",")}`},Q=function(e,t,n){let r=e.message.length*n.font_size,i=(g+r)/(n.displayed_time*100),o=t.vpos-e.vpos,s=i*o,c=n.font_size/2;return r+c-s},Z=function(e,t,n){let r=e.vpos+n.displayed_time*100,i=t.message.length*n.font_size,o=(g+i)/(n.displayed_time*100),s=r-t.vpos;return o*s-g},tt=function(e,t,n){if(!e||!t)return 0;let r=Q(e,t,n),i=Z(e,t,n);return r>i?r:i},C=function(e){let t=s=>("0"+s).substr(-2),n=t(e%100);e=Math.floor(e/100);let r=t(e%60);e=Math.floor(e/60);let i=t(e%60);return`${Math.floor(e/60)}:${i}:${r}.${n}`},et=function(e,t){let n=t.font_size+t.margin*2,r=Math.floor((x+t.margin)/n),i=Math.floor((x+t.margin-n/2)/n),o=r+i,s=Array.from({length:o},()=>null);return e.map(function(c,m){let u=0,a=1/0;for(let p=0;p<o;p++){let b=tt(s[p],c,t);if(b<=0){u=p;break}b<a&&(a=b,u=p)}s[u]=c;let _=C(c.vpos),f=C(c.vpos+t.displayed_time*100),d=c.message.length*t.font_size,y=g,v=-d,T=u<r?t.margin+u*(t.font_size+t.margin*2):n/2+t.margin+(u-r)*(t.font_size+t.margin*2),w=`{\\move(${y},${T},${v},${T})}`;return"Dialogue: "+[m,_,f,"style",c.user_id.replace(",","_"),"0000","0000","0000","",`${w}${c.message}`].join(",")}).join(`
`)},R=function(e,t){let n={...G,...t};return[J,K(n),X,et(e,n)].join(`
`)};var D=Y(A(),1),I=async function(e){let t=await fetch(e);if(!t.ok)throw new Error(await t.text());return t.json()},H=async function(e){if(!/^https?:\/\/kick\.com\/.*\/videos\//.test(e))throw new Error("URL\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093");let t=e.split("/").slice(-1)[0];return await I("https://kick.com/api/v1/video/"+t)},ot=function(e){return e.replace(/\[emote:.*?\]/g,"")};async function st(e,t){let n=[],r=e.entries();return await Promise.all(Array.from({length:t}).map(async()=>{for(let[i,o]of r)n[i]=await o()})),n}var L=async function(e){let t=new Date(e.livestream.start_time),n=new Date(t.getTime()+e.livestream.duration),r=Array.from({length:Math.ceil((n.getTime()-t.getTime())/5e3)},(m,u)=>u),i=[],o=new Set,s=r.map(m=>async()=>{let u=new Date(t.getTime()+5e3*m),a=`https://kick.com/api/v2/channels/${e.livestream.channel_id}/messages?start_time=${u.toISOString()}`,f=(await(0,D.default)(async()=>await I(a),{retries:100}))?.data?.messages;if(f)for(let d of f){if(o.has(d.id))continue;o.add(d.id);let y=new Date(d.created_at),v=(y.getTime()-t.getTime())/10;if(v<0)continue;let T=d.user_id.toString(),w=ot(d.content);w&&i.push({vpos:v,posted_at:y,user_id:T,message:w})}});return await st(s,10),i.toSorted((m,u)=>m.posted_at.getTime()-u.posted_at.getTime())},P=function(e){for(let t of e)t.vpos%100===0&&(t.vpos+=Math.floor(Math.random()*100));return e.toSorted((t,n)=>t.vpos-n.vpos)};var at=function(e,t){let n=new Blob([t],{type:"text/plain"}),r=document.createElement("a");return r.download=e,r.href=URL.createObjectURL(n),r.click()},ct=function(){let e=document.createElement("div");e.id="orcd-downloading",e.innerText="\u30B3\u30E1\u30F3\u30C8\u3092\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u4E2D...";let t=e.style;return t.position="fixed",t.width="100%",t.top=t.left="0",t.textAlign="center",t.padding="16px",t.fontSize="32px",t.fontWeight="bold",t.zIndex="99999999",t.color="#333",t.backgroundColor="#fff",t.boxShadow="0 0 40px #000",document.body.append(e)},V=function(){document.querySelector("#orcd-downloading")?.remove()},ut={oechanOPENREC:"\u041E",kickSadge:"\u0416"};(async function(){try{ct();let e=await H(window.location.href),t=await L(e);t=t.map(i=>{let o=i.message,s=!1;for(let[c,m]of Object.entries(ut))o.includes(c)&&(o=o.replaceAll(c,m),s=!0);return o.includes("[emote:")&&!s&&(o=""),i.message=o,i});let n=P(t),r=R(n,{font_size:36,displayed_time:5,outline:3});return at(`${e.livestream.session_title}.ass`,r),V()}catch(e){if(V(),e instanceof Error)return alert(e.message)}})();})();
