"use strict";var V=Object.create;var w=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var d=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var q=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of N(e))!H.call(t,o)&&o!==r&&w(t,o,{get:()=>e[o],enumerable:!(i=z(e,o))||i.enumerable});return t};var g=(t,e,r)=>(r=t!=null?V(U(t)):{},q(e||!t||!t.__esModule?w(r,"default",{value:t,enumerable:!0}):r,t));var x=d((K,S)=>{function c(t,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}S.exports=c;c.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};c.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};c.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var e=new Date().getTime();if(t&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},r),this._options.unref&&this._timer.unref(),!0};c.prototype.attempt=function(t,e){this._fn=t,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};c.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)};c.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)};c.prototype.start=c.prototype.try;c.prototype.errors=function(){return this._errors};c.prototype.attempts=function(){return this._attempts};c.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},e=null,r=0,i=0;i<this._errors.length;i++){var o=this._errors[i],n=o.message,s=(t[n]||0)+1;t[n]=s,s>=r&&(e=o,r=s)}return e}});var R=d(_=>{var B=x();_.operation=function(t){var e=_.timeouts(t);return new B(e,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})};_.timeouts=function(t){if(t instanceof Array)return[].concat(t);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var r in t)e[r]=t[r];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<e.retries;o++)i.push(this.createTimeout(o,e));return t&&t.forever&&!i.length&&i.push(this.createTimeout(o,e)),i.sort(function(n,s){return n-s}),i};_.createTimeout=function(t,e){var r=e.randomize?Math.random()+1:1,i=Math.round(r*Math.max(e.minTimeout,1)*Math.pow(e.factor,t));return i=Math.min(i,e.maxTimeout),i};_.wrap=function(t,e,r){if(e instanceof Array&&(r=e,e=null),!r){r=[];for(var i in t)typeof t[i]=="function"&&r.push(i)}for(var o=0;o<r.length;o++){var n=r[o],s=t[n];t[n]=function(f){var m=_.operation(e),a=Array.prototype.slice.call(arguments,1),p=a.pop();a.push(function(l){m.retry(l)||(l&&(arguments[0]=m.mainError()),p.apply(this,arguments))}),m.attempt(function(){f.apply(t,a)})}.bind(t,s),t[n].options=e}}});var M=d((Z,k)=>{k.exports=R()});var C=d((j,b)=>{var J=M();function X(t,e){function r(i,o){var n=e||{},s;"randomize"in n||(n.randomize=!0),s=J.operation(n);function u(a){o(a||new Error("Aborted"))}function f(a,p){if(a.bail){u(a);return}s.retry(a)?n.onRetry&&n.onRetry(a,p):o(s.mainError())}function m(a){var p;try{p=t(u,a)}catch(l){f(l,a);return}Promise.resolve(p).then(i).catch(function(h){f(h,a)})}s.attempt(m)}return new Promise(r)}b.exports=X});var O=g(require("fs"),1),L=g(require("path"),1);var E=g(C(),1),D=async function(t){let e=await fetch(t);if(!e.ok)throw new Error(await e.text());return e.json()},F=async function(t){if(!/^https?:\/\/kick\.com\/.*\/videos\//.test(t))throw new Error("URL\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093");let e=t.split("/").slice(-1)[0];return await D("https://kick.com/api/v1/video/"+e)};async function Y(t,e){let r=[],i=t.entries();return await Promise.all(Array.from({length:e}).map(async()=>{for(let[o,n]of i)r[o]=await n()})),r}var $=async function(t){let e=new Date(t.livestream.start_time),r=new Date(e.getTime()+t.livestream.duration),i=Array.from({length:Math.ceil((r.getTime()-e.getTime())/5e3)},(f,m)=>m),o=[],n=new Set,s=i.map(f=>async()=>{let m=new Date(e.getTime()+5e3*f),a=`https://kick.com/api/v2/channels/${t.livestream.channel_id}/messages?start_time=${m.toISOString()}`,l=(await(0,E.default)(async()=>await D(a),{retries:100}))?.data?.messages;if(l)for(let h of l){if(n.has(h.id))continue;n.add(h.id);let y=new Date(h.created_at),T=(y.getTime()-e.getTime())/10;if(T<0)continue;let P=h.user_id.toString(),v=h.content;v&&o.push({vpos:T,posted_at:y,user_id:P,message:v})}});return await Y(s,10),o.toSorted((f,m)=>f.posted_at.getTime()-m.posted_at.getTime())};function I(t){let e=`
[Script Info]
ScriptType: v4.00+
Collisions: Normal
PlayResX: 1920
PlayResY: 1080
Timer: 100.0000

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: Default,Arial,48,&H00FFFFFF,&H000000FF,&H00000000,&H64000000,-1,0,0,0,100,100,0,0,1,1,0,2,10,10,10,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
`;for(let r of t){let i=A(r.vpos),o=A(r.vpos+400);e+=`Dialogue: 0,${i},${o},Default,,0,0,0,,${r.message}
`}return e}function A(t){let e=Math.floor(t/100),r=t%100,i=Math.floor(e/3600),o=Math.floor(e%3600/60),n=e%60;return`${i}:${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}.${String(r).padStart(2,"0")}`}var W=async function(){let t=process.argv.slice(2);t.length<2&&(console.error("\u4F7F\u3044\u65B9: node kickcdemoji.js <\u52D5\u753BURL> <\u51FA\u529B\u30D5\u30A1\u30A4\u30EB\u540D>"),process.exit(1));let e=t[0],r=t[1];console.log("\u52D5\u753B\u60C5\u5831\u53D6\u5F97\u4E2D...");let i=await F(e);console.log("\u30B3\u30E1\u30F3\u30C8\u53D6\u5F97\u4E2D...");let n=(await $(i)).map(u=>({vpos:u.vpos,posted_at:u.posted_at,user_id:u.user_id,message:u.message}));console.log("ASS\u30D5\u30A1\u30A4\u30EB\u751F\u6210\u4E2D...");let s=I(i,n);O.default.writeFileSync(L.default.resolve(r),s,"utf-8"),console.log(`\u5B8C\u4E86: ${r}`)};W().catch(t=>{console.error(t),process.exit(1)});
